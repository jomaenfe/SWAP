### Practica 3: Balanceo de carga

**Instalación y configuración de nginx:** En primer lugar lo que vamos a hacer es instalar nginx, para ello usamos la orden `sudo apt-get install nginx`. Este software tiene la peculiaridad de que puede configurarse como servidor web y como servidor proxy o balanceador de carga. En ambos campos destaca por su alta eficiencia y el bajo consumo de recursos que lleva a cabo. Por defecto nginx vendrá configurado para iniciarse como servidor web de altas prestaciones por lo que en primer lugar debemos entrar en la configuración y cambiarla. El archivo de configuración que debemos eliminar se encuentra en la dirección `/etc/nginx/nginx.conf`. Una vez dentro de este archivo debemos comentar (o borrar en caso de que no funcione) la línea `include /etc/nginx/sites-enabled/*;`. Ahora debemos movernos a la dirección `/etc/nginx/conf.d/` y crear un archivo de configuración llamado "default.conf". En este archivo de configuración vamos a decirle a nginx los servidores entre los que queremos que reparta la carga y las directivas en las que le indicamos el tipo de balanceo que queremos realizar. En nuestro caso usamos el tipo "Round-Robin". Cuando esté terminada la configuración podemos probarlo usando "cURL" desde una máquina externa. Como se puede ver en la Captura 1 tenemos las tres máquinas corriendo y ejecutamos cURL varias veces seguidas con la misma dirección IP. Como se ve en la imagen he creado en cada máquina un archivo .php que se encarga de decir que máquina es la que lo está proporcionando.

![Captura 1](http://imgur.com/Oncz4ft.jpg "Captura 1")
Captura 1.

**Instalación y configuración de haproxy:** Para instalar haproxy tenemos que usar la orden `sudo apt-get install haproxy`. A diferencia de nginx, haproxy solo trabaja como balanceador entre servidores por lo que lo único que tenemos que hacer es completa el archivo de configuracion. Este archivo se encuentra en la ruta `/etc/haproxy/haproxy.conf`. Una vez dentro de este archivo tenemos que añadirle las directivas necesarias para configurar el tipo de balanceo, las direccciones de los servidores entre los que repartirá la carga y el tiempo máximo de conexión de cada uno. Una vez hecha la configuración procedemos a probar que reparte la carga. Al igual que con nginx voy a usar cURL para probar las conexiones desde la máquna anfitrión. En la captura dos volvemos a tener las 3 máquinas funcionando. En la primera linea del balanceador se observa que arranco el proceso de haproxy sin que de ningún error y ejecuto `ifconfig` para que se vea la dirección IP de la máquina. Más a la derecha en la ventana del CMD de windows podemos observar que al ejecutar `cURL` las máquinas nos responden en el orden configurado.

![Captura 2](http://imgur.com/fTiO1zr.jpg "Captura 2")
Captura 2.

**Prueba de carga para nginx y haproxy:** Para realizar la prueba carga voy a usar Apache Benchmark desde la línea de comandos del sistema anfitrión para que las máquinas que tienen que atender las peticiones no sufran la carga adicional de la benchmark que vamos a utilizar. Para realizar las pruebas la orden que voy a usar es `ab -n 1000 -c http://192.168.56.101/index.php` donde le estamos indicando que queremos que haga 1000 peticiones a la máquina y con concurrencia 10, es decir, de 10 en 10. En primer lugar voy a hacerlo con nginx. Como se puede ver en la parte izquierda de la captura 3, tenemos las tres máquinas corriendo, en el centro el balanceador y la derecha el CMD de Windows. En la ventana del balanceador, la primera linea está arrancando los servicios de nginx y después muestro la ip a la que voy a enviar las peticiones. Una vez hecha la prueba tendremos la información que sale en la ventana del CMD de windows donde podremos comparar los tiempos entre ngix y haproxy. La captura 4 es igual que la 3 sólo que cambiamos nginx por haproxy.

![Captura 3](http://imgur.com/2ico0Hs.jpg "Captura 3")
Captura 3.

![Captura 4](http://imgur.com/gYADVgc.jpg "Captura 4")
Captura 4.

Como se puede ver en las dos capturas, los tiempos de conexión son muy parecidos entre los dos balanceadores, aunque los de nginx son algo más bajos que los de haproxy. Principalmente haproxy destaca en la media y en la mediana de los tiempos de conexión que se dan mientras que nginx destaca en sus tiempos máximos de conexión que son más bajos que los de haproxy. Por otroa parte, el ratio de transferencia y las peticiones por segundo son superiores en haproxy. En definitiva son dos balanceadores que están bastante equilibrados entre sí, cada uno tiene aspectos más efcientes y menos eficientes con respecto al otro. 
