### Práctica 5: Replicación de bases de datos mysql

**Crear una base de datos, una tabla y añadir algunos datos:** En primer lugar lo que se propone en esta práctica es crear una base de datos, para ello lo primero que debemos hacer es comprobar si tenemos mysql instalado en nuestro sistema. En el caso de que no esté instalado se puede instalar con la orden `sudo apt-get install mysql-server`, para la instalación una parte importante es que nos pedirá la contraseña y debemos recordar para poder modificar la base de datos posteriormente. Una vez tengamos instalado mysql comenzamos a crear una base de datos. Para entrar en mysql usamos el comando `mysql -uroot -p` y escribimos la contraseña, nos dirá la versión y alguna información más sobre mysql, pero lo más importante para saber que estas dentro es que el promp cambia por "mysql>". Una vez estemos aqui seguiremos los siguientes pasos:

1. Creamos la base de datos con la orden `create database contactos;`. Creamos la base de datos contactos en nuestro caso.
2. Cambiamos la base de datos que está en uso con la orden `use contactos;`.
3. Ya tenemos en uso la base de datos que hemos creado, ahora vamos a crear una tabla en esta base de datos con la orden `create table datos(nombre varchar(100), tlf int);`. Yo he creado la tabla datos, con la información "nombre" que es un string de 100 caracteres y "tlf" que es un número entero. 
4. Para comprobar que se ha creado la tabla de forma correcta podemos ejecutar la orden `show tables;` y tiene que salir una imagen como la que sale en la captura 1.
5. Por último vamos a añadir información a la tabla. Para ello vamos a usar la orden `insert into datos(nombre,tlf) values ("pepe". 958349871);`. Con esto estamos insertando en el campo nombre a pepe y en el campo tlf su número de teléfono. Para comprobar que la información se ha añadido de forma correcta podemos usar la orden `select * from datos` que nos mostrará una imagen como la de la captura 1.

![Captura 1](http://imgur.com/f9QnfZ9.jpg "Captura 1")
Captura 1.

**Realizar una copia de seguridad completa de una base de datos y transferencia de la misma a otra máquina:** Una parte importante para respaldar información es hacer una copia de seguridad de una base de datos. En nuestro caso la vamos a usar para configurar otra base de datos como esclavo y que ella automaticamente replique la información pero para que pueda replicar la información primero debemos enviarle la base de datos que tenemos. Para realizar la copia de seguridad vamos a usar la orden "mysqldump". Su uso es muy simple, tan solo tendremos que seguir unos pasos para copiar las bases de datos de forma segura. En primer lugar tendremos que entrar dentro de mysql con el comando `mysql -uroot -p`, tras esto estaremos de nuevo dentro del sistema mysql, entonces ejecutaremos la orden `FLUSH TABLES WITH READ LOCK;` y para salir ejecutamos `quit`. Con esto lo que estamos haciendo es bloquear las tablas impidiendo cualquier tipo de acceso por parte de cualquier aplicación para que no se modifiquen las tablas mientras se está haciendo la copia de seguridad. Cuando hayamos bloqueado las tablas ejecutamos `mysqldump contactos -u root -p > /tmp/contactos.sql`. Lo que está haciendo exactamente es sacar una copia completa de la base de datos a la carpeta "/tmp" al archivo "contactos.sql" (Lo hacemos en tmp para que cuando reiniciemos el sistema se elimine de forma automática el archivo ya que cuando hagamos la transferencia a la máquina esclavo no nos será de ultilidad.) Una vez hecho esto nos pedirá la contraseña de mysql, se la introducimos y si no da ningún error la copia se habrá hecho correctamente. Cuando hayamos hecho la copia de seguridad (podemos comprobarlo ejecutando ls /tmp) podemos comenzar con la transferencia a la otra máquina. Para realizar la transferencia vamos a usar la herramienta scp. Para ello nos vamos a la máquina dos y, en mi caso, ejecutaremos la orden `scp 192.168.81.128:/tmp/contactos.sql /tmp/`, cuando haya terminado de hacer la copia volvemos a comprobar que la base de datos se encuentra en la segunda máquina también. Si al comprobar la transferencia vemos que todo se ha realiado de forma correcta ejecutaremos en la máquina uno `mysql -uroot -p` para entrar en el sistema y `UNLOCK TABLES` para que se puedan modificar las tablas de nuevo, como último paso escribimos `quit` para salir de mysql.

**Restaurar la copia de una base de datos en otra máquina:** Cuando tenemos todos los archivos listos en la máqina procederemos a realizar la restauración de una base de datos en otra. Para ello en primer paso entraremos dentro de la consola de mysql con `mysql -uroot -p `. En segundo lugar deberemos crear una base de datos con el mismo nombre que la que queremos replicar, en mi caso ejecutando la orden `create database 'contactos';` la crearíamos. Tras haber creado la base de datos importaremos la información que va a contener usando de nuevo la herramienta "mysqldump". En diferencia al caso anterior lo vamos a ejecutar para importar información, para ello tecleamos `mysqldump -u root -p contactos < /tmp/contactos.sql`. Tras ejectuar esta orden se habrá transferido toda la información de una base de datos a otra. Para comprobarlo podemos entrar en la termianl de mysql, cambiar la base de datos en uso con la orden `use contactos;` y mostrar la información que contiene con `select * from datos;`. Como se puede ver en la captura dos, tenemos la misma información en las dos bases de datos en máquinas distintas.

![Captura 2](http://imgur.com/44hNeVl.jpg "Captura 2")
Captura 2.

**Configurar los servidores como maestro-esclavo para automatizar la replicación de datos entre bases de datos:** Si hemos completado todos los pasos anteriores tendremos dos bases de datos exactamente iguales en dos máquinas diferentes y tan solo para terminar nos quedará automatizar la transferencia de datos entre ellas para que la esclavo actúe como copia de seguridad de la maestra y esté todo redundado. Para realizar configuración dentro de mysql nos tendermos que mover al archivo de configuración y modificarlo, para ello ejecuto `sudo nano /etc/mysql/mysql.conf.d/mysqld.cnf`. Ya dentro del archivo debemos realizar los siguientes pasos. En primer lugar comentamos (usando "#") la línea `#bind-address 127.0.0.1`, en segundo lugar descomentamos (le quitamos el caracter "#" a la línea.) las líneas `log_error=/var/log/mysql/error.log` y `server_id= 1`, por último comprobamos que la línea `log_bin = /var/log/mysql/bin.log` está descomentada y tal como la escribo. Si no está igual debemos modificarla. Lo único que nos queda es reiniciar el servicio `sudo service mysql restart` y si no da ningún error es que hemos configurado de forma exitosa la máquina 1. Para configurar la máquina 2 repetimos los pasos anteriores sólo cambiando uno `server_id = 2` y volvemos a reiniciar el servicio para comprobar que está funcionando bien. Para continuar con la configuración debemos volver al maestro y crear un usuario para darle permisos para la replicación de la información. Para ello seguiremos los siguientes pasos:
1. Entramos en mysql `mysql -uroot -p` e introducimos la contraseña.
2. Ejecutamos `CREATE USER esclavo IDENTIFIED BY 'esclavo';`
3. Ejecutamos `GRANT REPLICATION SLAVE ON *.* TO 'esclavo'@'%' IDENTIFIED BY 'esclavo';`.
4. Ejecutamos `FLUSH PRIVILEGES;`.
5. Por último ejecutamos `FLUSH TABLES WITH READ LOCK;` y ya habríamos terminado con la creación del usuario.

Para comprobar que el usuario se ha creado de forma correcta ejecutamos `SHOW MASTER STATUS;` y deberíamos ver una imagen como la que se ve en la captura 3. Si está todo correcto ahora toca volver a la máquina que va a hacer de esclavo para darle los datos del maestro, para ello tendremos que recordar la tabla que hemos visto en la captura 3. Para darle los datos del maestro ejecutaremos `CHANGE MASTER TO MASTER_HOST='192.168.81.128', MASTER_USER='esclavo', MASTER_PASSWORD='esclavo', MASTER_LOG_FILE='bin.000001', MASTER_LOG_POS=, MASTER_PORT=3306;`. Si al ejecutar no da errores sólo faltaría iniciar el esclavo, para ello ejecutamos `START SLAVE;`. Si seguimos estos pasos con exito ya estaría configurada la replicación automática entre maestro y esclavo, pero para poder hacer pruebas primero debemos desbloquear las tablas, para ello `UNLOCK TABLES;`. Existe una forma en la que podemos asegurarnos de que el esclavo está funcionando correctamente, para ello en la máquina esclavo ejecutamos `SHOW SLAVE STATUS\G`, nos mostrará una pantalla como la que se ve en la captura 4. Buscamos la variable "Seconds_Behind_Master", si es distinto de null significará que el esclavo funciona perfectamente. Si esta variable tiene el valor null las demás mostrarán mensajes de error que ayudarán a repararlo. 

![Captura 3](http://imgur.com/gzFVtoU.jpg "Captura 3")
Captura 3.

![Captura 4](http://imgur.com/Z1Ots2Q.jpg "Captura 4")
Captura 4.

Por último, vamos a hacer una prueba para que se vea que el esclavo replica la información del maestro. Nos vamos al maestro e introducimos nuevos datos en la tabla "datos" de la base de datos "contactos". Yo en concreto voy a introducir otro nombre y otro número de teléfono. Para ello ejecuto `insert into datos(nombre,tlf) values ("Antonio", 958652315);`, después de esto ejecuto `select * from datos` para asegurarme de que se ha introducido la información bien en la tabla y me voy al esclavo. Dentro del esclavo vuelvo a ejecutar la orden select y comprobamos que la información se ha duplicado correctamente como se puede ver en la captura 5.

![Captura 5](http://imgur.com/7uZ2tAJ.jpg "Captura 5")
Captura 5.